---
title: '241 Project (Summer 2017): Effect of Meditation on Blood Pressure'
author: "Erika Lawrence, Thong Bui, Matt Post"
output:
  html_document: default
  pdf_document: default
---
```{r}
library(data.table)
library(sandwich)
library(lmtest)
library(stargazer)
library(RColorBrewer)

```

## Exploring data

Description our subjects (friends and family)
##### How do we use Pre_existing_blood_pressure into our model? Convert it to 1 (low),2 (avg),3 (high)?


```{r}
d <- fread("../data/meditation.csv")
# Should be 30 subjects
nrow(d)
str(d)
#d[13]
d <- data.table(d)
# Reverse group number: 1 is meditation first (treatment), 0 is coloring 1st
#d2 <- d[ID != 13 , .(Group = ifelse(Group == 0, 1, 0),  # Exclude 13th person
d2 <- d[ , .(Group = ifelse(Group == 0, 1, 0),
             caffeinated_drinks,
             Years_practice,
             hours_since_last_caffeinated_drink,
             is_online = ifelse(Online_in_person == 'O', 1, 0),
#             Pre_existing_blood_pressure,
             pre_existing_BP = ifelse(Pre_existing_blood_pressure == 'Low', 1, 
                                      ifelse(Pre_existing_blood_pressure == 'Avg', 2, 3)),
             B4_Med_BP_Sys,
             After_Med_BP_Sys,
             B4_color_BP_Sys,
             After_color_BP_Sys) ]

summary(d2)

#hist(d2$Group)
#hist(d2$is_online, breaks=30)
par(mfrow=c(3,2))
hist(d2$Years_practice, breaks = 30)
hist(d2$hours_since_last_caffeinated_drink, breaks = 30)
hist(d2$B4_Med_BP_Sys, breaks = 30)
hist(d2$After_Med_BP_Sys, breaks = 30)
hist(d2$B4_color_BP_Sys, breaks = 30)
hist(d2$After_color_BP_Sys, breaks = 30)

#display.brewer.all()
cols<-brewer.pal(n=3,name="Set1")
# Note: Group 0 is treatment group!
cols_t1<-cols[d2$Group+1]
med_diff <- d2$B4_Med_BP_Sys - d2$After_Med_BP_Sys
color_diff <-  d2$B4_color_BP_Sys - d2$After_color_BP_Sys
par(mfrow =c(1,2))
plot(d2$Group ~ med_diff , col=cols_t1, pch=16)
legend("center",legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16)
plot(d2$Group ~ color_diff , col=cols_t1, pch=16)
legend("center",legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16)

# Plot b4 vs after meditation for 2 groups
plot(After_Med_BP_Sys ~ B4_Med_BP_Sys, data=d2 , col=cols_t1, pch=16)
legend(x=98,y=200, legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16, xpd=TRUE)

# Plot b4 vs after coloring for 2 groups
plot(After_color_BP_Sys ~ B4_color_BP_Sys, data=d2 , col=cols_t1, pch=16)
legend(x=100,y=175, legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16, xpd=TRUE)

```

## Linear Regression model with difference-in-difference Estimate

##### Choice of outcome variables: How do we use other After_*_BP* variables?

##### How to check for covariate balances?

```{r}
cat("Age Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Age_Group))

cat("\nGender Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Gender))

cat("\nReligion Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Religion))

cat("\nMeditation Experience Covariate Balance:\n")
d <- transform(d, experience=cut(Years_practice,  
                              breaks=c(-1,1, 10, 25, 50),
                             labels= c(0,10, 25, 50)))
(col_table_years = table(d$Group, d$experience))

cat("\nPre-existing Blood Pressure Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$Pre_existing_blood_pressure))

cat("\nCaffeinated Drinks Covariate Balance:\n")
(cov_caff = table(d$Group[d$hours_since_last_caffeinated_drink < 2],
                    d$caffeinated_drinks[d$hours_since_last_caffeinated_drink < 2]))

cat("\nPrevious Activity Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$previous_strenuous_activity))


cat("\nPrevious Relaxation Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$Before_Meditation_how_relaxed))

cat("\nIn Person vs Online Covariate Balance:\n")
(cov_online = table(d$Group, d$Online_in_person))

```

##### Coloring first (group 0): placebo
##### Meditation first (group 1): treatment

##### ATE between meditation vs color
```{r}
ate <- mean(d2[d2$Group == 1, After_Med_BP_Sys], na.rm=TRUE) - mean(d2[d2$Group == 0, After_color_BP_Sys], na.rm=TRUE)
ate

d2$med_diff = d2$After_Med_BP_Sys - d2$B4_Med_BP_Sys
d2$col_diff = d2$After_color_BP_Sys - d2$B4_color_BP_Sys
ate_diff = mean(d2$med_diff, na.rm=TRUE) - mean(d2$col_diff, na.rm=TRUE)
ate_diff
```

###Models on meditation data

```{r}
# On meditation variables on treatment group
m1 <- lm(After_Med_BP_Sys ~ pre_existing_BP + Years_practice + caffeinated_drinks + hours_since_last_caffeinated_drink + B4_Med_BP_Sys , data=d2[Group==1])
summary(m1)
#stargazer(m1, m2, type = "text")
```

### Models on coloring data

```{r}
# On coloring variables regardless of group
m3 <- lm(After_color_BP_Sys ~ pre_existing_BP + Years_practice + caffeinated_drinks + hours_since_last_caffeinated_drink + B4_color_BP_Sys, data=d2[Group== 0])

# On coloring variables & group interaction
#m4 <- lm(After_color_BP_Sys ~ pre_existing_BP + Years_practice + caffeinated_drinks + hours_since_last_caffeinated_drink + B4_color_BP_Sys + Group + B4_color_BP_Sys * Group, data=d2)
#stargazer(m3, m4, type = "text")
summary(m3)

```
# Generalization
##### Can't generalize from this finding because:
##### Subjects are our friends and relatives. This sample is not randomized from the general population therefore doesn't represent the population's distribution