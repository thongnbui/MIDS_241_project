---
title: '241 Project (Summer 2017): Effect of Meditation on Blood Pressure'
author: "Erika Lawrence, Thong Bui, Matt Post"
output:
  html_document: default
  pdf_document: default
---

##Abstract:


##Introduction:
###What is the question we are trying to answer? 
###Why does it matter?
####Dangers of high blood pressure
####Systolic vs Diastolic Blood Pressure vs Pulse
###Background on Meditation studies
###Experiment
####Overview
####Considerations
#####Why within-subject design
#####Why coloring
####Challenges
#####BP measurement device precission vs incorrect use of the device for online people?
#####Constrained by subject inexperience (15 minute meditations only)
#####Constrained by subject willingness (single experiment in one sitting, rather than successive days)

##Experimental Design:

##Data:
```{r}
library(data.table)
library(sandwich)
library(lmtest)
library(stargazer)
library(RColorBrewer)

```

## Exploring data

Description our subjects (friends and family)

```{r}
d <- fread("../data/meditation.csv")
# Should be 30 subjects
nrow(d)
str(d)
#d[13]
d <- data.table(d)
# Reverse group number: 1 is meditation first (treatment), 0 is coloring 1st
# We are remove ID = 13 because this person's BP number ob
d2 <- d[ID != 13 , .(Group = ifelse(Group == 0, 1, 0),  # Exclude 13th person
#d2 <- d[ , .(Group = ifelse(Group == 0, 1, 0),
             caffeinated_drinks,
             Years_practice,
             hours_since_last_caffeinated_drink,
#             hours_since_last_caffeinated_drink = ifelse(caffeinated_drinks == 0, NA, hours_since_last_caffeinated_drink),
             in_person = ifelse(Online_in_person == 'I', 1, 0),
#             Pre_existing_blood_pressure,
             pre_existing_BP = ifelse(Pre_existing_blood_pressure == 'Low', 1, 
                                      ifelse(Pre_existing_blood_pressure == 'Avg', 2, 3)),
             B4_Med_BP_Sys, B4_Med_BP_PUL,
             After_Med_BP_Sys, After_Med_BP_PUL,
             B4_color_BP_Sys, B4_color_BP_Pul, 
             After_color_BP_Sys, After_color_BP_Pul) ]

summary(d2)

#hist(d2$Group)
#hist(d2$is_online, breaks=30)
par(mfrow=c(3,2))
hist(d2$Years_practice, breaks = 30)
hist(d2$hours_since_last_caffeinated_drink, breaks = 30)
hist(d2$B4_Med_BP_Sys, breaks = 30)
hist(d2$After_Med_BP_Sys, breaks = 30)
hist(d2$B4_color_BP_Sys, breaks = 30)
hist(d2$After_color_BP_Sys, breaks = 30)

#display.brewer.all()
cols<-brewer.pal(n=3,name="Set1")
# Note: Group 0 is treatment group!
cols_t1<-cols[d2$Group+1]
med_diff <- d2$B4_Med_BP_Sys - d2$After_Med_BP_Sys
color_diff <-  d2$B4_color_BP_Sys - d2$After_color_BP_Sys
par(mfrow =c(1,2))
plot(d2$Group ~ med_diff , col=cols_t1, pch=16)
legend("center",legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16)
plot(d2$Group ~ color_diff , col=cols_t1, pch=16)
legend("center",legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16)

# Plot b4 vs after meditation for 2 groups
plot(After_Med_BP_Sys ~ B4_Med_BP_Sys, data=d2 , col=cols_t1, pch=16)
legend(x=98,y=200, legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16, xpd=TRUE)

# Plot b4 vs after coloring for 2 groups
plot(After_color_BP_Sys ~ B4_color_BP_Sys, data=d2 , col=cols_t1, pch=16)
legend(x=100,y=175, legend=c("Group 1: meditation", "Group 0: coloring"), col=cols_t1, pch=16, xpd=TRUE)

```

## Linear Regression model with difference-in-difference Estimate

##### Choice of outcome variables: How do we use other After_*_BP* variables?

##Covariate Balance Check

```{r}
cat("Age Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Age_Group))

cat("\nGender Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Gender))

cat("\nReligion Covariate Balance:\n")
(cov_table_age = table(d$Group, d$Religion))

cat("\nMeditation Experience Covariate Balance:\n")
d <- transform(d, experience=cut(Years_practice,  
                              breaks=c(-1,1, 10, 25, 50),
                             labels= c(0,10, 25, 50)))
(col_table_years = table(d$Group, d$experience))

cat("\nPre-existing Blood Pressure Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$Pre_existing_blood_pressure))

cat("\nCaffeinated Drinks Covariate Balance:\n")
(cov_caff = table(d$Group[d$hours_since_last_caffeinated_drink < 2],
                    d$caffeinated_drinks[d$hours_since_last_caffeinated_drink < 2]))

cat("\nPrevious Activity Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$previous_strenuous_activity))


cat("\nPrevious Relaxation Covariate Balance:\n")
(cov_pre_bp = table(d$Group, d$Before_Meditation_how_relaxed))

cat("\nIn Person vs Online Covariate Balance:\n")
(cov_online = table(d$Group, d$Online_in_person))

```

##Model Building:
##### Coloring first (group 0): placebo
##### Meditation first (group 1): treatment
##### Outcome variables: med_sys_diff, col_sys_diff
##### Covariates: 
* pre_existing_BP, 
* Group: 1 means meditation first, 0 means coloring first
* Years_practice, 
* caffeinated_drinks, 
* hours_since_last_caffeinated_drink, 
* in_person

##### ATE between meditation vs color
```{r}
d2$med_sys_diff = d2$After_Med_BP_Sys - d2$B4_Med_BP_Sys
d2$col_sys_diff = d2$After_color_BP_Sys - d2$B4_color_BP_Sys
(ate_sys_diff = mean(d2$med_sys_diff, na.rm=TRUE) - mean(d2$col_sys_diff, na.rm=TRUE))

d2$med_pul_diff = d2$After_Med_BP_PUL - d2$B4_Med_BP_PUL
d2$col_pul_diff = d2$After_color_BP_Pul - d2$B4_color_BP_Pul
(ate_col_diff = mean(d2$med_pul_diff, na.rm=TRUE) - mean(d2$col_pul_diff, na.rm=TRUE))
```

### Models on meditation data
##### Is this the correct interaction term: Years_practice * Group?

```{r}
# On meditation Sys
m1 <- lm(med_sys_diff ~ pre_existing_BP + Years_practice + Group + Years_practice * Group + caffeinated_drinks + hours_since_last_caffeinated_drink + in_person, data=d2)

# On meditation pulse
m2 <- lm(med_pul_diff ~ pre_existing_BP + Years_practice + Group + Years_practice * Group + caffeinated_drinks + hours_since_last_caffeinated_drink + in_person, data=d2)
```

### Models on coloring data

```{r}
# On coloring systolic
m3 <- lm(col_sys_diff ~ pre_existing_BP + Years_practice + Group + Years_practice * Group + caffeinated_drinks + hours_since_last_caffeinated_drink + in_person, data=d2)

# On coloring pulse & group interaction
m4 <- lm(col_pul_diff ~ pre_existing_BP + Years_practice + Group + Years_practice * Group + caffeinated_drinks + hours_since_last_caffeinated_drink + in_person, data=d2)

stargazer(m1, m2, m3, m4, type = "text")
```
##### Results:
* From high-level, while the coefficients show mostly decreases in blood pressure (BP) and pulses in both coloring and mediation exercises, the 4 models show lots of the coefficients are NOT statistically significant so we can't determine any causal effects from them

Now, let's look at the models' covariates with statistical significance:

* m1 - difference in BP after meditation: hours_since_last_caffeinated_drink increases BP by 0.454 which is a small number. Interaction term Years_practice:Group means that in group 1 (meditation first), number of years of meditation increases BP by 0.6 which is also a small amount. The other variables mostly show decreases in BP but we can't rely on them to draw causal inference because they are NOT statistically significant

* m2 - difference in pulse after meditation: for Group 1, the pulse decreases by 7.434. 

* m3 - difference in BP after coloring: there are no statistically significant coefficients here

* m4 - difference in pulse after coloring: also no statistically significant coefficients

##Summary
###Conclusions

###Generalization
##### Can't generalize from this finding because:
##### Subjects are our friends and relatives. This sample is not randomized from the general population therefore doesn't represent the population's distribution
###Future Research